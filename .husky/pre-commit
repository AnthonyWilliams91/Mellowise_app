#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "ğŸš€ Running pre-commit checks..."

# Check if this is the initial commit
if git rev-parse --verify HEAD >/dev/null 2>&1
then
    against=HEAD
else
    # Initial commit: diff against an empty tree object
    against=$(git hash-object -t tree /dev/null)
fi

# Get list of staged files
staged_files=$(git diff --cached --name-only --diff-filter=ACM)

if [ -z "$staged_files" ]; then
    echo "No staged files to check"
    exit 0
fi

echo "ğŸ“ Staged files:"
echo "$staged_files" | sed 's/^/  /'

# Run TypeScript type checking
echo "ğŸ” Type checking..."
if ! npx tsc --noEmit; then
    echo "âŒ TypeScript type checking failed"
    exit 1
fi

# Run ESLint on staged files
echo "ğŸ”§ Linting..."
echo "$staged_files" | grep -E '\.(js|jsx|ts|tsx)$' | xargs -r npx eslint
if [ $? -ne 0 ]; then
    echo "âŒ Linting failed"
    exit 1
fi

# Run Prettier on staged files
echo "ğŸ’… Formatting check..."
echo "$staged_files" | xargs -r npx prettier --check
if [ $? -ne 0 ]; then
    echo "âŒ Code formatting check failed"
    echo "ğŸ’¡ Run 'npm run format' to fix formatting issues"
    exit 1
fi

# Run tests affected by staged files
echo "ğŸ§ª Running tests..."
if ! npm run test:affected 2>/dev/null || ! npm run test -- --passWithNoTests --silent; then
    echo "âŒ Tests failed"
    exit 1
fi

# Check for secrets or sensitive information
echo "ğŸ”’ Security check..."
if echo "$staged_files" | xargs -r grep -Hn -E "(api_key|secret|password|token)" --include="*.js" --include="*.ts" --include="*.jsx" --include="*.tsx" --exclude-dir=node_modules; then
    echo "âŒ Potential secrets detected in staged files"
    echo "ğŸ’¡ Please remove sensitive information before committing"
    exit 1
fi

# Check package.json and package-lock.json are in sync
if echo "$staged_files" | grep -q "package\.json"; then
    if [ ! -f "package-lock.json" ] || [ "package.json" -nt "package-lock.json" ]; then
        echo "âŒ package-lock.json is out of sync with package.json"
        echo "ğŸ’¡ Run 'npm install' to update package-lock.json"
        exit 1
    fi
fi

# Size check for large files
echo "ğŸ“ Checking file sizes..."
large_files=$(echo "$staged_files" | xargs -r ls -la | awk '$5 > 1048576 {print $9, "(" $5 " bytes)"}')
if [ -n "$large_files" ]; then
    echo "âš ï¸  Large files detected:"
    echo "$large_files"
    echo "ğŸ’¡ Consider using Git LFS for large binary files"
fi

echo "âœ… All pre-commit checks passed!"